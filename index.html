<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Foto Capture & Upload (no-preflight)</title>
<style>
  body { font-family: Arial; margin: 12px; }
  video, canvas { width: 100%; max-width: 600px; border: 1px solid #ccc; }
  button { padding: 8px 12px; margin: 6px; }
  #status { margin-top: 8px; font-weight: bold; }
</style>
</head>
<body>
  <h3>Ambil Foto & Upload (Test)</h3>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <div>
    <button id="start">Mulai Kamera</button>
    <button id="capture" disabled>Ambil Foto</button>
    <button id="upload" disabled>Upload</button>
  </div>
  <div id="status">Status: menunggu</div>

<script>
const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJKDujTY9_8KFT0sN7BCiEt2k4OD0B1YxzfyavNL-7eV7bjfunRNU-mc5ilcDCIDCnHg/exec'; // Ganti dengan URL Web App kamu

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const startBtn = document.getElementById('start');
const capBtn = document.getElementById('capture');
const upBtn = document.getElementById('upload');
const statusDiv = document.getElementById('status');

let lastDataUrl = null;
let lastLat = '';
let lastLng = '';
let lastAddress = '';

startBtn.onclick = async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
    video.srcObject = stream;
    status('Kamera aktif');
    capBtn.disabled = false;
    upBtn.disabled = true;
    canvas.style.display = 'none';
    video.style.display = 'block';
  } catch (e) {
    status('Gagal akses kamera: ' + e.message, true);
  }
};

capBtn.onclick = () => {
  if (!navigator.geolocation) {
    status('Geolocation tidak didukung', true);
    return;
  }
  status('Mengambil lokasi...');
  navigator.geolocation.getCurrentPosition((pos) => {
    lastLat = pos.coords.latitude;
    lastLng = pos.coords.longitude;
    lastAddress = `Lat:${lastLat.toFixed(6)}, Lng:${lastLng.toFixed(6)}`;

    // Setup canvas ukuran sama dengan video
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;

    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // Watermark background
    const rectH = Math.round(canvas.height * 0.08);
    ctx.fillStyle = 'rgba(0,0,0,0.45)';
    ctx.fillRect(0, canvas.height - rectH, canvas.width, rectH);

    // Watermark text
    ctx.fillStyle = 'white';
    ctx.font = `${Math.max(14, Math.round(canvas.width / 40))}px sans-serif`;
    const ts = new Date().toLocaleString();
    ctx.fillText(ts, 10, canvas.height - rectH / 2 + 6);
    ctx.fillText(lastAddress, 10, canvas.height - rectH / 2 + 28);

    lastDataUrl = canvas.toDataURL('image/jpeg', 0.85);

    status('Foto siap. Tekan Upload.');
    upBtn.disabled = false;

    // Show preview canvas, hide video
    canvas.style.display = 'block';
    video.style.display = 'none';

  }, (err) => {
    status('Gagal ambil lokasi: ' + err.message, true);
  }, { enableHighAccuracy: true, timeout: 10000 });
};

upBtn.onclick = async () => {
  if (!lastDataUrl) {
    status('Tidak ada foto untuk diupload', true);
    return;
  }
  status('Mengirim ke server...');
  try {
    const params = new URLSearchParams();
    params.append('image', lastDataUrl);
    params.append('lat', lastLat);
    params.append('lng', lastLng);
    params.append('address', lastAddress);
    params.append('timestamp', new Date().toISOString());
    params.append('user', 'mobile-user');

    const resp = await fetch(APPS_SCRIPT_URL, {
      method: 'POST',
      mode: 'cors',
      body: params // application/x-www-form-urlencoded
    });

    const json = await resp.json();
    if (json.status === 'ok') {
      status('Upload sukses â€” file: ' + json.fileUrl);
      upBtn.disabled = true;
      capBtn.disabled = true;
    } else {
      status('Upload error: ' + (json.message || 'Unknown'), true);
    }
  } catch (e) {
    status('Request failed: ' + e.message, true);
  }
};

function status(msg, isErr = false) {
  statusDiv.textContent = 'Status: ' + msg;
  statusDiv.style.color = isErr ? 'red' : 'green';
}
</script>
</body>
</html>