<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ambil Foto dengan Watermark - BPJS</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; }
  label { display: block; margin-top: 10px; }
  input, select { width: 100%; padding: 8px; margin-top: 4px; }
  video, canvas { width: 100%; max-width: 500px; margin-top: 10px; border: 1px solid #ccc; }
  button { margin: 5px; padding: 10px 15px; }
  #status { margin-top: 10px; font-weight: bold; }
  .success { color: green; }
  .error { color: red; }
</style>
</head>
<body>

<h2>Ambil Foto dengan Watermark BPJS</h2>

<label for="username">Nama User</label>
<select id="username">
  <option value="">-- Pilih User --</option>
  <option value="AK02240012 - AHMAD FAUZI">AK02240012 - AHMAD FAUZI</option>
  <option value="AK02240016 - ANDRI SURYANA">AK02240016 - ANDRI SURYANA</option>
  <option value="AK02220036 - ARIS SAFRUDIN">AK02220036 - ARIS SAFRUDIN</option>
  <option value="AK02230129 - ATIKA PAHLA SUARDIMAN">AK02230129 - ATIKA PAHLA SUARDIMAN</option>
  <option value="AK02220002 - CECEP SAEPULLAH">AK02220002 - CECEP SAEPULLAH</option>
  <option value="AK02220004 - JULITA">AK02220004 - JULITA</option>
  <option value="AK02240015 - LELI KAMELIA DAMAYANTI">AK02240015 - LELI KAMELIA DAMAYANTI</option>
  <option value="AK02250001 - MUHAMAD WILDAN MAULANA FADILAH">AK02250001 - MUHAMAD WILDAN MAULANA FADILAH</option>
  <option value="AK02240004 - SARIAH TUL AISAH">AK02240004 - SARIAH TUL AISAH</option>
</select>

<div class="input-row">
  <div>
    <label for="namaPeserta">Nama Peserta</label>
    <input type="text" id="namaPeserta" placeholder="Masukkan nama peserta" />
  </div>
  <div>
    <label for="nikPeserta">NIK Peserta</label>
    <input type="text" id="nikPeserta" placeholder="Masukkan NIK peserta" />
  </div>
</div>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" style="display:none;"></canvas>

<div>
  <button id="startBtn">Mulai Kamera</button>
  <button id="captureBtn" disabled>Ambil Foto</button>
  <button id="uploadBtn" disabled>Upload Foto</button>
</div>

<div id="status"></div>

<script>
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyoVN4BiMdc_0aPEugiK_IkmmyM9LFcTQhrXFJ_cQ6U66yAUrCNqclioPVZLBl9NoYCmQ/exec';

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  const startBtn = document.getElementById('startBtn');
  const captureBtn = document.getElementById('captureBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const usernameInput = document.getElementById('username');
  const namaPesertaInput = document.getElementById('namaPeserta');
  const nikPesertaInput = document.getElementById('nikPeserta');
  const statusDiv = document.getElementById('status');

  let lastImageDataUrl = null;
  let lastLat = '';
  let lastLng = '';
  let lastTimestamp = '';
  let lastAddress = '';

  function setStatus(msg, isError = false) {
    statusDiv.textContent = msg;
    statusDiv.className = isError ? 'error' : 'success';
  }

  async function getAddressFromCoords(lat, lng) {
    const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
    try {
      const res = await fetch(url, { headers: { 'User-Agent': 'Mozilla/5.0' } });
      const data = await res.json();
      if (!data.address) return '';
      const addr = data.address;
      const parts = [
        addr.road || '',
        addr.suburb || addr.neighbourhood || addr.village || '',
        addr.city_district || addr.county || addr.city || addr.town || '',
        addr.state || ''
      ].filter(Boolean);
      return parts.join(', ');
    } catch {
      return '';
    }
  }

  startBtn.addEventListener('click', async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream;
      setStatus('Kamera aktif, silakan ambil foto.');
      captureBtn.disabled = false;
      uploadBtn.disabled = true;
      canvas.style.display = 'none';
      video.style.display = 'block';
    } catch (e) {
      setStatus('Gagal mengakses kamera: ' + e.message, true);
    }
  });

  captureBtn.addEventListener('click', () => {
    if (!navigator.geolocation) {
      setStatus('Geolocation tidak didukung oleh browser.', true);
      return;
    }
    setStatus('Mengambil lokasi...');
    navigator.geolocation.getCurrentPosition(async pos => {
      lastLat = pos.coords.latitude.toFixed(6);
      lastLng = pos.coords.longitude.toFixed(6);
      lastTimestamp = new Date().toLocaleString();

      lastAddress = await getAddressFromCoords(lastLat, lastLng);

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;

      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      ctx.save();
      ctx.globalAlpha = 0.15;
      ctx.fillStyle = "#FFFFFF";
      ctx.font = `${canvas.width / 15}px Arial`;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      ctx.translate(canvas.width / 2, canvas.height / 2);
      ctx.rotate(-Math.atan(canvas.height / canvas.width));

      const text = "Perisai K02";
      const stepX = canvas.width / 2.5;
      const stepY = canvas.height / 3;

      for (let x = -canvas.width; x < canvas.width; x += stepX) {
        for (let y = -canvas.height; y < canvas.height; y += stepY) {
          ctx.fillText(text, x, y);
        }
      }
      ctx.restore();

      ctx.fillStyle = "white";
      ctx.font = "18px Arial";
      ctx.textAlign = "left";

      ctx.fillText(`${lastTimestamp} | ${lastAddress || `Lat: ${lastLat}, Lng: ${lastLng}`}`, 10, canvas.height - 20);

      lastImageDataUrl = canvas.toDataURL('image/jpeg', 0.85);

      setStatus('Foto siap untuk diupload.');
      uploadBtn.disabled = false;
      canvas.style.display = 'block';
      video.style.display = 'none';
    }, err => {
      setStatus('Gagal mendapatkan lokasi: ' + err.message, true);
    }, { enableHighAccuracy: true, timeout: 10000 });
  });

  uploadBtn.addEventListener('click', async () => {
    if (!lastImageDataUrl) {
      setStatus('Tidak ada foto untuk diupload.', true);
      return;
    }

    if (!usernameInput.value.trim()) {
      alert('Nama User harus dipilih.');
      usernameInput.focus();
      return;
    }
    if (!namaPesertaInput.value.trim()) {
      alert('Nama Peserta harus diisi.');
      namaPesertaInput.focus();
      return;
    }
    if (!nikPesertaInput.value.trim()) {
      alert('NIK Peserta harus diisi.');
      nikPesertaInput.focus();
      return;
    }

    const user = usernameInput.value.trim(); // kode + nama
    const namaPeserta = namaPesertaInput.value.trim();
    const nikPeserta = nikPesertaInput.value.trim();

    const timestampForFilename = new Date().toISOString().replace(/[:.-]/g, '');

    setStatus('Mengirim foto ke server...');
    uploadBtn.disabled = true;

    const filename = `${user}_${namaPeserta}_${nikPeserta}_${timestampForFilename}.jpg`;

    const params = new URLSearchParams();
    params.append('image', lastImageDataUrl);
    params.append('lat', lastLat);
    params.append('lng', lastLng);
    params.append('timestamp', new Date().toISOString());
    params.append('user', user);
    params.append('namaPeserta', namaPeserta);
    params.append('nikPeserta', nikPeserta);
    params.append('address', lastAddress || `Lat:${lastLat},Lng:${lastLng}`);
    params.append('filename', filename);

    try {
      const resp = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        body: params,
      });
      const json = await resp.json();
      if (json.status === 'ok') {
        setStatus('Upload sukses! File URL: ' + json.fileUrl);
        uploadBtn.disabled = true;
        captureBtn.disabled = true;
        startBtn.disabled = true;
        usernameInput.disabled = true;
        namaPesertaInput.disabled = true;
        nikPesertaInput.disabled = true;
      } else {
        setStatus('Upload gagal: ' + (json.message || 'Tidak diketahui'), true);
        uploadBtn.disabled = false;
      }
    } catch (e) {
      setStatus('Request gagal: ' + e.message, true);
      uploadBtn.disabled = false;
    }
  });
</script>

</body>
</html>
