<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Foto Capture & Upload</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 12px; }
    video, canvas { width: 100%; max-width: 600px; border: 1px solid #ccc; }
    .controls { margin-top: 10px; }
    button { padding: 8px 12px; margin-right: 8px; cursor: pointer; }
    #status { margin-top: 12px; font-weight: bold; }
  </style>
</head>
<body>
  <h3>Ambil Foto & Upload</h3>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <div class="controls">
    <button id="startBtn">Mulai Kamera</button>
    <button id="captureBtn" disabled>Ambil Foto</button>
    <button id="uploadBtn" disabled>Upload Foto</button>
  </div>

  <div id="status">Status: Menunggu aksi...</div>

<script>
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyduDN0voQJwws_AeaoYmfOCKhiJ1faKXdGZUbEkhTNOFmwyTJS9TK1O7O5aRCyf4z4/exec'; // Ganti dengan URL Web App kamu

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const startBtn = document.getElementById('startBtn');
  const captureBtn = document.getElementById('captureBtn');
  const uploadBtn = document.getElementById('uploadBtn');
  const statusDiv = document.getElementById('status');

  let lastImageDataUrl = null;
  let lastLat = null;
  let lastLng = null;
  let lastAddress = '';

  startBtn.onclick = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
      video.srcObject = stream;
      status('Kamera aktif');
      captureBtn.disabled = false;
    } catch (e) {
      status('Gagal akses kamera: ' + e.message, true);
    }
  };

  captureBtn.onclick = () => {
    if (!navigator.geolocation) {
      status('Browser tidak mendukung geolocation', true);
      return;
    }
    status('Mengambil lokasi...');
    navigator.geolocation.getCurrentPosition((pos) => {
      lastLat = pos.coords.latitude;
      lastLng = pos.coords.longitude;
      lastAddress = `Lat: ${lastLat.toFixed(6)}, Lng: ${lastLng.toFixed(6)}`;

      // Capture foto dari video
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Tambah watermark (waktu + lokasi)
      const timestamp = new Date().toLocaleString();
      const rectHeight = Math.round(canvas.height * 0.08);
      ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
      ctx.fillRect(0, canvas.height - rectHeight, canvas.width, rectHeight);
      ctx.fillStyle = 'white';
      ctx.font = `${Math.max(14, Math.round(canvas.width / 40))}px sans-serif`;
      ctx.fillText(timestamp, 10, canvas.height - rectHeight / 2 + 6);
      ctx.fillText(lastAddress, 10, canvas.height - rectHeight / 2 + 28);

      // Dapatkan data URL
      lastImageDataUrl = canvas.toDataURL('image/jpeg', 0.85);
      status('Foto siap untuk diupload');
      uploadBtn.disabled = false;
    }, (err) => {
      status('Gagal ambil lokasi: ' + err.message, true);
    }, { enableHighAccuracy: true, timeout: 10000 });
  };

  uploadBtn.onclick = async () => {
    if (!lastImageDataUrl) {
      status('Tidak ada foto untuk diupload', true);
      return;
    }
    status('Mengupload foto...');
    try {
      const payload = {
        image: lastImageDataUrl,
        lat: lastLat,
        lng: lastLng,
        address: lastAddress,
        timestamp: new Date().toISOString(),
        user: 'mobile-user' // bisa diganti sesuai user
      };
      const resp = await fetch(APPS_SCRIPT_URL, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const json = await resp.json();
      if (json.status === 'ok') {
        status('Upload berhasil! File URL: ' + json.fileUrl);
        uploadBtn.disabled = true;
      } else {
        status('Upload error: ' + (json.message || 'Unknown error'), true);
      }
    } catch (e) {
      status('Upload gagal: ' + e.message, true);
    }
  };

  function status(msg, isError = false) {
    statusDiv.textContent = 'Status: ' + msg;
    statusDiv.style.color = isError ? 'red' : 'green';
  }
</script>
</body>
</html>